<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">WARENIX - Admin</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="/dashboard">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" href="/logout">Logout</a></li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container mt-4">
      <h1 class="mb-3">User Management</h1>
      <div id="user-list">Loading users...</div>
      <div id="user-form" style="display:none" class="mt-4"></div>
    </div>
    <script>
      async function loadUsers() {
        const resp = await fetch('/admin/users');
        if (!resp.ok) return document.getElementById('user-list').textContent = 'Failed to load users';
        const users = await resp.json();
        let html = '<table class="table"><thead><tr><th>Email</th><th>Role</th><th>Actions</th></tr></thead><tbody>';
        for (const u of users) {
          html += `<tr><td>${u.email}</td><td>${u.role}</td><td>
            <button class='btn btn-sm btn-warning' onclick='showEditUserForm("${u._id}", "${u.email}", "${u.role}")'>Edit</button>
            <button class='btn btn-sm btn-danger' onclick='deleteUser("${u._id}")'>Delete</button>
          </td></tr>`;
        }
        html += '</tbody></table>';
        document.getElementById('user-list').innerHTML = html;
      }
      loadUsers();

      function showEditUserForm(id, email, role) {
        document.getElementById('user-form').style.display = '';
        document.getElementById('user-form').innerHTML = `
          <h4>Edit User</h4>
          <form onsubmit="editUser(event, '${id}')">
            <input name="email" type="email" class="form-control mb-2" value="${email}" required />
            <select name="role" class="form-control mb-2">
              <option value="user" ${role==='user'?'selected':''}>User</option>
              <option value="admin" ${role==='admin'?'selected':''}>Admin</option>
            </select>
            <button class="btn btn-warning" type="submit">Update</button>
            <button class="btn btn-secondary ms-2" type="button" onclick="hideUserForm()">Cancel</button>
          </form>
        `;
      }

      function hideUserForm() {
        document.getElementById('user-form').style.display = 'none';
        document.getElementById('user-form').innerHTML = '';
      }

      async function editUser(e, id) {
        e.preventDefault();
        const form = e.target;
        const body = {
          email: form.email.value,
          role: form.role.value
        };
        const resp = await fetch(`/admin/users/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        if (resp.ok) {
          hideUserForm();
          loadUsers();
        } else {
          alert('Failed to update user');
        }
      }

      async function deleteUser(id) {
        if (!confirm('Delete this user?')) return;
        const resp = await fetch(`/admin/users/${id}`, { method: 'DELETE' });
        if (resp.ok) {
          loadUsers();
        } else {
          alert('Failed to delete user');
        }
      }
    </script>
  </body>
</html>
